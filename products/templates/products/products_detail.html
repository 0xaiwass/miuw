{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %} فروشگاه {% endblock %}
{% block products_detail %}

    <main class="container">
        <!-- Breadcrumb -->
        <nav class="flex mt-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                <li class="inline-flex items-center">
                    <a href="{% url 'home:home' %}"
                       class="inline-flex items-center text-sm gap-x-1  text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                        <svg class="size-4 mb-0.5">
                            <use href="#home"></use>
                        </svg>
                        صفحه اصلی
                    </a>
                </li>
                <li class="inline-flex items-center">
                    <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="m1 9 4-4-4-4"></path>
                    </svg>
                    <a href="{% url 'products:products' %}"
                       class="inline-flex items-center text-sm gap-x-1  text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                        فروشگاه
                    </a>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                            <path stroke="currentColor" stroke-linecap="round"
                                  stroke-linejoin="round" stroke-width="2"
                                  d="m1 9 4-4-4-4">
                            </path>
                        </svg>
                        <span class="ms-1 text-sm  text-gray-500 md:ms-2 dark:text-gray-400">جزییات محصول</span>
                    </div>
                </li>
            </ol>
        </nav>
        <!-- PRODUCT DETAILS SECTION -->
        <section
                class="mt-5 flex flex-col lg:flex-row items-start gap-4 child:rounded-lg child:bg-white child:dark:bg-gray-800 child:shadow child:p-4">

            <!-- IMAGE & INFO BOX Container -->
            <div class="w-full lg:w-3/4">
                <div class="flex flex-col md:flex-row justify-start gap-x-8 xl:gap-x-2 items-start">

                    <!-- IMAGE SLIDER -->
                    <div class="w-2/4 hidden md:flex flex-col justify-center items-center gap-y-4">
                        <!-- Main image -->
                        <span class="open-sliderModal" data-index="0">
                            <img src="{{ product.image.url }}" class="cursor-pointer object-cover rounded-lg"
                                 alt="{{ product.name }}">
                        </span>

                        <!-- Thumbnails -->
                        <div class="grid grid-cols-12 child:col-span-3 gap-x-4 child:size-16 child:rounded-lg child:cursor-pointer">
                            {% for img in product.extra_images %}
                                {% if forloop.counter <= 3 %}
                                    <div class="p-1 open-sliderModal" data-index="{{ forloop.counter }}">
                                        <img src="{{ img.image.url }}" class="object-cover rounded-lg" alt="{{ product.name }}">
                                    </div>
                                {% elif forloop.counter == 4 %}
                                    <!-- Ellipsis thumbnail -->
                                    <div class="overflow-hidden relative open-sliderModal" data-index="{{ forloop.counter }}">
                                        <svg class="absolute size-8 text-gray-100 top-4 left-4 z-10">
                                            <use href="#ellipsis"></use>
                                        </svg>
                                        <img src="{{ img.image.url }}" class="object-cover rounded-lg blur-sm"
                                             alt="{{ product.name }}">
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- SLIDER MODAL -->
                    <div class="slider-modal hidden">
                        <div class="flex w-full h-fit items-center justify-between">
                            <h1 class="font-DanaMedium text-lg">{{ product.name }}</h1>
                            <svg class="size-6 cursor-pointer close-sliderModal">
                                <use href="#x-mark"></use>
                            </svg>
                        </div>

                        <div class="swiper ProductDetailsSlider mt-14 px-10 w-96 relative">
                            <div class="swiper-wrapper child:w-full child:rounded-lg child:overflow-hidden">
                                <!-- Main image -->
                                <div class="swiper-slide">
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                                </div>
                                <!-- Extra images -->
                                {% for img in product.extra_images %}
                                    <div class="swiper-slide">
                                        <img src="{{ img.image.url }}" alt="{{ product.name }}" class="object-cover rounded-lg">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Slider navigation -->
                        <button class="slider-navigate_btn absolute right-40 top-[17rem] border dark:border-gray-700 border-gray-200 button-prev-ProductDetailsSlider z-20">
                            <svg class="size-6 -rotate-90"><use href="#chevron"></use></svg>
                        </button>
                        <button class="slider-navigate_btn absolute left-40 top-[17rem] border dark:border-gray-700 border-gray-200 button-next-ProductDetailsSlider z-10">
                            <svg class="size-6 rotate-90"><use href="#chevron"></use></svg>
                        </button>
                    </div>

                    <!-- INFOS -->
                    <div class="w-full md:w-3/4 flex flex-col gap-y-7">

                        <!-- Breadcrumb & Wishlist -->
                        <div class="flex items-center justify-between">
                            <a href="{% url 'products:products' %}?category={{ model_name }}"
                               class="font-DanaMedium text-sky-400">
                                / {{ verbose_name }} / {{ product.name }} /
                            </a>
                            <div class="hidden md:flex items-center gap-x-2">
                                <div class="tooltip">
                                    <button class="rounded-full p-1.5 app-border app-hover">
                                        <svg class="size-4 md:size-5"><use href="#heart"></use></svg>
                                    </button>
                                    <div class="tooltiptext">علاقه‌مندی</div>
                                </div>
                            </div>
                        </div>

                        <!-- MOBILE SLIDER -->
                        <div class="flex md:hidden">
                            <div class="swiper MobileProductSlider w-full">
                                <div class="swiper-wrapper w-full child:w-full child:overflow-hidden child:rounded-lg">
                                    <div class="swiper-slide">
                                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                                    </div>
                                    {% for img in product.extra_images.all %}
                                        <div class="swiper-slide">
                                            <img src="{{ img.image.url }}" alt="{{ product.name }}">
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="swiper-pagination MobileProductSlider-pagination"></div>
                            </div>
                        </div>

                        <!-- Title & Short Description -->
                        <div class="flex flex-col gap-y-3">
                            <p class="text-lg font-DanaDemiBold dark:text-gray-300">{{ product.name }}</p>
                            {% if product.short_description %}
                                <p class="text-sm text-gray-300 dark:text-gray-500">
                                    {{ product.short_description }}
                                </p>
                            {% endif %}
                        </div>

                        <!-- Features Box -->
                        <div class="w-full flex flex-col gap-y-4">
                            <div class="w-full flex flex-col gap-y-4">
                                <h1 class="font-DanaDemiBold text-lg dark:text-gray-200">ویژگی‌ها</h1>

                                <div class="grid grid-cols-12 gap-2 child:p-2 child:min-h-16
                                    child:bg-gray-100 dark:child:bg-gray-900
                                    child:rounded-lg child:flex child:flex-col child:gap-y-1.5">

                                    {% for label, value in product.get_top_features %}
                                        <div class="col-span-12 md:col-span-6 xl:col-span-4">
                                            <p class="text-sm text-gray-500">{{ label }}</p>
                                            <p class="line-clamp-1 font-DanaDemiBold text-sm text-slate-800 dark:text-slate-200">
                                                {{ value }}
                                            </p>
                                        </div>
                                    {% endfor %}

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guarantees -->
                <div class="mt-10 lg:mr-2 grid grid-cols-12 child:col-span-6 xl:child:col-span-3 gap-x-1 gap-y-2 lg:gap-4
                    child:border child:text-gray-400 child:dark:border-white/20 child:border-gray-200
                    child:rounded-lg child:h-12 child:p-2 child:flex child:items-center child:gap-x-1
                    lg:child:gap-x-2 child:text-sm lg:text-base">
                    <span><svg class="w-4 h-4 lg:w-6 lg:h-6"><use href="#arrow-path-rounded-square"></use></svg><p>ضمانت بازگشت کالا</p></span>
                    <span><svg class="w-4 h-4 lg:w-6 lg:h-6"><use href="#check-badge"></use></svg><p>تضمین اصالت کالا</p></span>
                    <span><svg class="w-4 h-4 lg:w-6 lg:h-6"><use href="#calender-day"></use></svg><p>پشتیبانی کل هفته</p></span>
                    <span><svg class="w-4 h-4 lg:w-6 lg:h-6"><use href="#truke"></use></svg><p>ارسال به سراسر ایران</p></span>
                </div>
            </div>

            <!-- PRICE & ADD TO CART BOX -->
            <div id="purchaseBox-{{ product.id }}" class="w-full lg:w-1/4 lg:sticky top-5 flex flex-col gap-y-6">
                <!-- PRICE (display only) -->
                <div class="flex items-center gap-x-1">
                    <p class="text-2xl font-DanaDemiBold" id="unitPriceDisplay-{{ product.id }}">{{ product.offer_price|intcomma }}</p>
                    <p>تومان</p>
                </div>

                <!-- Quantity Selector -->
                <div class="w-full flex items-center justify-between gap-x-1 rounded-lg border border-gray-200 dark:border-white/20 py-2 px-3"
                     role="group" aria-label="quantity selector">
                    <svg role="button" tabindex="0" class="w-6 h-6 increment cursor-pointer" aria-hidden="true"><use href="#plus"></use></svg>

                    <input type="number"
                           id="quantityInput-{{ product.id }}"
                           name="quantity"
                           min="1" max="20" value="1"
                           class="custom-input mr-4 text-lg bg-transparent text-center"
                           readonly>
                    <svg role="button" tabindex="0" class="w-6 h-6 decrement cursor-pointer" aria-hidden="true"><use href="#minus"></use></svg>
                </div>

                <!-- Total Price -->
                <div class="w-full flex items-center gap-x-1 justify-between dark:bg-gray-900 dark:text-gray-400
                    bg-gray-100 transition-all rounded-lg py-2 px-2 xl:px-3 font-DanaMedium text-sm xl:text-base">
                    <p>مجموع خرید :</p>
                    <p id="totalPrice-{{ product.id }}">{{ product.offer_price|intcomma }} تومان</p>
                </div>

                {% if request.user.is_authenticated %}

                    <a href="#" id="addToCartBtn-{{ product.id }}"
                       data-product-id="{{ product.id }}"
                       data-product-model="{{ product.model_name }}"
                       class="py-2 px-4 bg-blue-600 flex-center hover:bg-blue-700 transition-all rounded-lg text-gray-200">
                        افزودن به سبدخرید
                    </a>
                {% else %}
                    <button class="w-full flex items-center gap-x-1 justify-center
                                    bg-blue-500 text-white hover:bg-blue-600
                                    transition-all rounded-lg shadow py-2">
                        جهت خرید وارد حساب کاربری خود شوید.
                    </button>
                {% endif %}


                <div class="text-sm text-gray-400 flex xl:items-center gap-x-1">
                    <svg class="w-5 h-5"><use href="#info"></use></svg>
                    <p>ارسال رایگان برای خریدهای بالای 400 هزار تومان</p></div>
            </div>
        </section>
        <section class="mx-4 mt-10 lg:mt-20">
            <div class="flex flex-col gap-y-4 xs:flex-row items-center justify-between w-full text-center xs:text-start">
                <div class="flex items-center gap-x-2 sm:gap-x-4">
                    <span class="size-12 hidden xs:flex rounded-lg bg-white shadow-lg dark:bg-gray-800 flex-center">
                        <svg class="size-7 text-gray-700 dark:text-gray-100">
                            <use href="#mobile"></use>
                        </svg>
                    </span>
                    <div class="space-y-1 md:space-y-1">
                        <h3 class="text-xl md:text-2xl font-MorabbaMedium text-gray-800 dark:text-gray-50">محصولات
                            <span class="text-blue-600 dark:text-blue-500">پرفروش</span>
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-300">پرفروش‌ترین و بروزترین محصولات</p>
                    </div>
                </div>
                <div class="w-full xs:w-auto flex justify-between xs:justify-end  items-center gap-x-2">
                    <div class="flex items-center gap-x-2">
                        <button class="slider-navigate_btn BestSelling-prev-slide">
                            <svg class="size-6 -rotate-90">
                                <use href="#chevron"></use>
                            </svg>
                        </button>
                        <button class="slider-navigate_btn BestSelling-next-slide">
                            <svg class="size-6 rotate-90">
                                <use href="#chevron"></use>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Latest products Slider -->
            <div class="swiper BestSelling mt-5 w-full">
                <div class="swiper-wrapper py-5">
                    {% for latest in latest_products %}
                        <!-- PRODUCT ITEM -->
                        <div class="swiper-slide product-card group">
                            <!-- product header -->
                            <div class="product-card_header">
                                <div class="flex items-center gap-x-2">
                                    <div class="tooltip">
                                        <button class="rounded-full p-1.5 app-border app-hover">
                                            <svg class="size-4">
                                                <use href="#shopping-cart"></use>
                                            </svg>
                                        </button>
                                        <div class="tooltiptext">سبد خرید</div>
                                    </div>
                                    <div class="tooltip">
                                        <button class="rounded-full p-1.5 app-border app-hover">
                                            <svg class="size-4">
                                                <use href="#heart"></use>
                                            </svg>
                                        </button>
                                        <div class="tooltiptext">علاقه مندی</div>
                                    </div>
                                </div>
                                <!-- badge offer -->
                                {% if latest.off_percent and latest.off_percent > 0 %}
                                    <span class="product-card_badge">{{ latest.off_percent }}% تخفیف</span>
                                {% endif %}
                            </div>

                            <div class="relative w-full h-48 overflow-hidden rounded-lg">
                                {% if latest.image %}
                                    <img src="{{ latest.image.url }}" alt="{{ latest.name }}">
                                {% else %}
                                    <img src="{% static 'images/placeholder.png' %}" alt="no image">
                                {% endif %}
                            </div>

                            <!-- product footer -->
                            <div class="space-y-2">
                                <a href="{% url 'products:products_detail' category=latest.get_category slug=latest.slug %}" class="product-card_link">
                                    {{ latest.name }}
                                </a>
                                <!-- Rate and Price -->
                                <div class="product-card_price-wrapper">
                                    <div class="product-card_price">
                                        {% if latest.off_percent %}
                                            <del>{{ latest.old_price | intcomma}} <h6>تومان</h6></del>
                                            <p>{{ latest.offer_price | intcomma}}</p><span>تومان</span>
                                        {% else %}
                                            <p>{{ latest.offer_price | intcomma}}</p><span>تومان</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        <!-- PRODUCTS INFORMATION -->
        <section class="relative mt-10 flex flex-col items-start gap-4 rounded-lg bg-white dark:bg-gray-800 shadow p-4">
            <!-- Tab Buttons -->
            <div class="w-full py-3 flex items-center gap-x-6 child:font-DanaMedium tab-buttons z-10 border-b border-gray-600/20 dark:border-b-gray-200/20">
                <button class="tab-btn text-blue-500" data-target="tab1">معرفی محصول</button>
                <button class="tab-btn text-gray-500 dark:text-gray-300" data-target="tab2">مشخصات</button>
                <button class="tab-btn text-gray-500 dark:text-gray-300" data-target="tab3">
                </button>
            </div>

            <!-- معرفی محصول -->
            <div class="tab-content tab1 block">
                <h2 class="font-DanaDemiBold border-b-2 border-blue-500 w-fit p-1 text-lg">معرفی</h2>
                <p class="mt-4 leading-8">
                    {{ product.description|safe }}
                </p>
            </div>

            <!-- مشخصات -->
            <div class="tab-content tab2 hidden w-full lg:w-[50%]">
                <h2 class="font-DanaDemiBold border-b-2 border-blue-500 w-fit p-1 text-lg">مشخصات کلی</h2>

                <div class="p-4 my-5 w-full mx-auto flex justify-center items-center gap-x-20">
                    <ul class="space-y-3 text-gray-500 dark:text-gray-300 lg:w-2/4 child:pt-2">
                        {% for label, value in product.get_specs %}
                            <li>{{ label }}</li>
                        {% endfor %}
                    </ul>
                    <ul class="space-y-3 text-gray-800 dark:text-gray-200 lg:w-2/4 divide-y divide-gray-200 dark:divide-gray-700 font-DanaMedium child:line-clamp-1">
                        {% for label, value in product.get_specs %}
                            <li class="pt-2">{{ value }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            {#            <!-- دیدگاه‌ها -->#}
            {#            <div class="tab-content tab3 hidden w-full">#}
            {#                <div class="flex items-center gap-x-2 mb-6">#}
            {#                    <h2 class="font-DanaMedium text-2xl">دیدگاه‌ها</h2>#}
            {#                    <p class="text-sm text-blue-500">({{ product.comments.count }} دیدگاه)</p>#}
            {#                </div>#}
            {##}
            {#                <div class="w-full flex flex-col md:flex-row items-start gap-10">#}
            {#                    <!-- Submit Comment -->#}
            {#                    <div class="lg:w-1/4 flex flex-col w-full">#}
            {#                        <p class="font-DanaMedium text-lg mb-2">ثبت دیدگاه</p>#}
            {#                        <form method="post" action="{% url 'products:add_comment' product.id %}">#}
            {#                            {% csrf_token %}#}
            {#                            <input type="text" name="title" placeholder="عنوان" class="tailwind-input">#}
            {#                            <textarea name="text" class="h-24 tailwind-input mt-3" placeholder="متن دیدگاه"></textarea>#}
            {#                            <button class="rounded-lg p-2 mt-3 bg-blue-500 hover:bg-blue-600 text-white transition-all">#}
            {#                                ثبت#}
            {#                            </button>#}
            {#                        </form>#}
            {#                    </div>#}
            {##}
            {#                    <!-- All Comments -->#}
            {#                    <ul class="lg:w-3/4 flex flex-col gap-y-2 child:w-full">#}
            {#                        {% for comment in product.comments.all %}#}
            {#                            <li class="py-4 border-b border-gray-200 dark:border-b-gray-200/20">#}
            {#                                <!-- Title -->#}
            {#                                <div class="flex items-center gap-x-2">#}
            {#                                    <h2 class="font-DanaMedium text-lg mb-1">{{ comment.title }}</h2>#}
            {#                                    <span class="px-2 py-1 mb-2 rounded-lg bg-blue-500 text-white text-xs">خریدار</span>#}
            {#                                </div>#}
            {#                                <!-- Comment Text -->#}
            {#                                <div class="flex-col">#}
            {#                                    <h2 class="flex items-center gap-x-1 {% if comment.is_recommended %}text-green-500{% else %}text-red-500{% endif %} mb-4">#}
            {#                                        <svg class="w-4 h-4">#}
            {#                                            <use href="#hand-{% if comment.is_recommended %}up{% else %}down{% endif %}"></use>#}
            {#                                        </svg>#}
            {#                                        {% if comment.is_recommended %}پیشنهاد میشود{% else %}پیشنهاد نمی‌شود{% endif %}#}
            {#                                    </h2>#}
            {#                                    <p class="text-gray-500 dark:text-gray-200 mb-2">{{ comment.text }}</p>#}
            {#                                </div>#}
            {#                                <!-- Footer -->#}
            {#                                <div class="mt-2 flex items-center justify-between text-gray-400 text-sm">#}
            {#                                    <p>{{ comment.created_at|date:"d M Y" }}</p>#}
            {#                                    <p>{{ comment.author }}</p>#}
            {#                                    <div class="flex items-center gap-x-2">#}
            {#                                        <button class="text-green-600">{{ comment.likes }}#}
            {#                                            <svg class="w-4 h-4"><use href="#hand-up"></use></svg>#}
            {#                                        </button>#}
            {#                                        <button class="text-red-500">{{ comment.dislikes }}#}
            {#                                            <svg class="w-4 h-4"><use href="#hand-down"></use></svg>#}
            {#                                        </button>#}
            {#                                    </div>#}
            {#                                </div>#}
            {#                            </li>#}
            {#                        {% empty %}#}
            {#                            <li class="py-4 text-gray-500">هنوز دیدگاهی ثبت نشده است.</li>#}
            {#                        {% endfor %}#}
            {#                    </ul>#}
            {#                </div>#}
            {#            </div>#}
        </section>
    </main>

    <!-- JS -->
    <script>
        const slider = new Swiper('.ProductDetailsSlider', {
            loop: false,
            navigation: {
                nextEl: '.button-next-ProductDetailsSlider',
                prevEl: '.button-prev-ProductDetailsSlider',
            },
        });

        document.querySelectorAll('.open-sliderModal').forEach(el => {
            el.addEventListener('click', () => {
                const index = parseInt(el.dataset.index) || 0;
                document.querySelector('.slider-modal').classList.remove('hidden');
                slider.slideTo(index, 0);
            });
        });

        document.querySelector('.close-sliderModal').addEventListener('click', () => {
            document.querySelector('.slider-modal').classList.add('hidden');
        });
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pid = {{ product.id }};
            const container = document.getElementById(`purchaseBox-${pid}`);
            if (!container) return;

            const qtyInput = document.getElementById(`quantityInput-${pid}`);
            const totalPriceEl = document.getElementById(`totalPrice-${pid}`);
            const incBtn = container.querySelector('.increment');
            const decBtn = container.querySelector('.decrement');
            const addBtn = document.getElementById(`addToCartBtn-${pid}`);

            const unitPrice = Number({{ product.offer_price|default:0 }});

            function formatPrice(num) {
                return (Number(num) || 0).toLocaleString('fa-IR') + ' تومان';
            }

            function clampQty(v) {
                v = Number(v) || 1;
                if (v < 1) v = 1;
                if (v > 20) v = 20;
                return Math.floor(v);
            }

            function updateTotal() {
                const qty = clampQty(qtyInput.value);
                qtyInput.value = qty;
                totalPriceEl.textContent = formatPrice(qty * unitPrice);
                decBtn.classList.toggle('opacity-50', qty <= 1);
                incBtn.classList.toggle('opacity-50', qty >= 20);
            }

            [incBtn, decBtn].forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', () => {
                    qtyInput.value = clampQty(Number(qtyInput.value) + (btn === incBtn ? 1 : -1));
                    updateTotal();
                });
            });

            qtyInput.addEventListener('input', updateTotal);
            qtyInput.addEventListener('change', updateTotal);

            // Add to cart click
            addBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const productId = addBtn.dataset.productId;
                const productModel = addBtn.dataset.productModel;
                const quantity = qtyInput.value;

                // Redirect to cart view with query params
                const url = `{% url 'carts:add_to_cart' %}?product_id=${productId}&product_model=${productModel}&quantity=${quantity}`;
                window.location.href = url;
            });

            updateTotal();
        });
    </script>
{% endblock %}
